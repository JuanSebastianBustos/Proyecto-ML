{% extends "base.html" %}

{% block title %}Resultado Lote {{ lote.codigo_lote }} - CHOCOBREW{% endblock %}

{% block extra_css %}
<style>
    .cacao-theme {
        background: linear-gradient(135deg, #3E2723 0%, #5D4037 100%);
    }
    
    .qr-container {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: inline-block;
    }
    
    .resultado-card {
        animation: slideUp 0.6s ease-out;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .nutri-table {
        background: white;
        border: 3px solid #8B4513;
        border-radius: 10px;
    }
    
    .nutri-table th {
        background: #8B4513;
        color: white;
        padding: 12px;
    }
    
    .btn-cacao {
        background: #8B4513;
        color: white;
        font-weight: 700;
        padding: 12px 30px;
        border-radius: 50px;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-cacao:hover {
        background: #A0522D;
        transform: translateY(-3px);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero -->
<section class="cacao-theme" style="min-height: 30vh; display: flex; align-items: center;">
    <div class="container text-center text-white">
        <i class="fas fa-check-circle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
        <h1 class="display-5 fw-bold">Análisis Completado</h1>
        <p class="lead">Lote: {{ lote.codigo_lote }}</p>
    </div>
</section>

<!-- Resultados -->
<section class="py-5">
    <div class="container">
        <!-- Código QR Principal -->
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto">
                <div class="card-beer p-5 text-center resultado-card">
                    <h2 class="fw-bold mb-4" style="color: #3E2723;">
                        <i class="fas fa-qrcode me-2"></i>Código QR Generado
                    </h2>
                    
                    {% if lote.qr_code %}
                    <div class="qr-container mx-auto mb-4">
                        <img src="data:image/png;base64,{{ lote.qr_code }}" alt="QR Code" style="max-width: 300px;">
                    </div>
                    <p class="text-muted mb-4">Escanea este código para ver toda la información del producto</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <button onclick="descargarQR()" class="btn btn-cacao">
                            <i class="fas fa-download me-2"></i>Descargar QR
                        </button>
                        <button onclick="imprimirEtiqueta()" class="btn btn-outline-secondary">
                            <i class="fas fa-print me-2"></i>Imprimir Etiqueta
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se pudo generar el código QR. Instala: pip install qrcode[pil]
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Información del Lote -->
        <div class="row mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4">
                    <h4 class="fw-bold mb-4" style="color: #3E2723;">
                        <i class="fas fa-info-circle me-2" style="color: #8B4513;"></i>
                        Información del Lote
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="p-3 rounded" style="background: #F5F5DC;">
                                <div class="text-muted small mb-1">Código de Lote</div>
                                <div class="fw-bold" style="font-size: 1.2rem; color: #3E2723;">{{ lote.codigo_lote }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded" style="background: #F5F5DC;">
                                <div class="text-muted small mb-1">Fecha de Elaboración</div>
                                <div class="fw-bold" style="font-size: 1.2rem; color: #3E2723;">{{ lote.fecha_elaboracion }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 rounded" style="background: #FFE4E1;">
                                <div class="text-muted small mb-1">Fecha de Vencimiento</div>
                                <div class="fw-bold" style="font-size: 1.2rem; color: #dc3545;">{{ lote.fecha_vencimiento }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calificación Predicha -->
        <div class="row mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4 text-center">
                    <h4 class="fw-bold mb-3" style="color: #3E2723;">Calificación de Calidad Predicha</h4>
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #8B4513, #A0522D); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <span style="font-size: 4rem; color: white; font-weight: 900;">{{ lote.puntuacion }}</span>
                        </div>
                    </div>
                    <div class="stars mb-3" style="color: #FFD700; font-size: 2rem;">
                        {% for i in range(5) %}
                            {% if i < lote.puntuacion %}
                                <i class="fas fa-star"></i>
                            {% elif i < lote.puntuacion + 0.5 %}
                                <i class="fas fa-star-half-alt"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <h3>
                        <span class="badge px-4 py-2" style="background: #8B4513; font-size: 1.3rem;">
                            {{ lote.categoria }}
                        </span>
                    </h3>
                </div>
            </div>
        </div>

        <!-- Características del Producto -->
        <div class="row mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4">
                    <h4 class="fw-bold mb-4" style="color: #3E2723;">
                        <i class="fas fa-flask me-2" style="color: #8B4513;"></i>
                        Características del Producto
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <div class="p-3 rounded text-center" style="background: #F5F5DC;">
                                <i class="fas fa-percentage" style="color: #dc3545; font-size: 2rem;"></i>
                                <div class="text-muted small mt-2">ABV</div>
                                <div class="fw-bold" style="font-size: 1.5rem; color: #3E2723;">{{ lote.abv }}%</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 rounded text-center" style="background: #F5F5DC;">
                                <i class="fas fa-leaf" style="color: #28a745; font-size: 2rem;"></i>
                                <div class="text-muted small mt-2">IBU</div>
                                <div class="fw-bold" style="font-size: 1.5rem; color: #3E2723;">{{ lote.ibu }}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 rounded text-center" style="background: #F5F5DC;">
                                <i class="fas fa-palette" style="color: #8B4513; font-size: 2rem;"></i>
                                <div class="text-muted small mt-2">SRM</div>
                                <div class="fw-bold" style="font-size: 1.5rem; color: #3E2723;">{{ lote.srm }}</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 rounded text-center" style="background: #FFE4B5;">
                                <i class="fas fa-seedling" style="color: #8B4513; font-size: 2rem;"></i>
                                <div class="text-muted small mt-2">Cacao</div>
                                <div class="fw-bold" style="font-size: 1.5rem; color: #3E2723;">{{ lote.porcentaje_cacao }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Nutricional -->
        <div class="row mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4">
                    <h4 class="fw-bold mb-4" style="color: #3E2723;">
                        <i class="fas fa-apple-alt me-2" style="color: #28a745;"></i>
                        Información Nutricional (por 100ml)
                    </h4>
                    <div class="table-responsive">
                        <table class="table nutri-table mb-0">
                            <thead>
                                <tr>
                                    <th>Nutriente</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Unidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Energía</strong></td>
                                    <td class="text-end">{{ lote.nutricional.calorias }}</td>
                                    <td class="text-end">kcal</td>
                                </tr>
                                <tr style="background: #E3F2FD;">
                                    <td><strong>Carbohidratos totales</strong></td>
                                    <td class="text-end"><strong>{{ lote.nutricional.carbohidratos }}</strong></td>
                                    <td class="text-end"><strong>g</strong></td>
                                </tr>
                                <tr style="background: #F5F5F5;">
                                    <td style="padding-left: 30px; font-size: 0.9rem; color: #666;">
                                        <i class="fas fa-level-up-alt fa-rotate-90" style="opacity: 0.5; margin-right: 5px;"></i>
                                        Incluye azúcares
                                    </td>
                                    <td class="text-end" style="color: #666;">{{ lote.nutricional.azucares }}</td>
                                    <td class="text-end" style="color: #666;">g</td>
                                </tr>
                                <tr>
                                    <td><strong>Proteínas</strong></td>
                                    <td class="text-end">{{ lote.nutricional.proteinas }}</td>
                                    <td class="text-end">g</td>
                                </tr>
                                <tr>
                                    <td><strong>Grasas</strong></td>
                                    <td class="text-end">{{ lote.nutricional.grasas }}</td>
                                    <td class="text-end">g</td>
                                </tr>
                                <tr style="background: #FFF8DC; border-top: 3px solid #8B4513;">
                                    <td><strong>Alcohol</strong></td>
                                    <td class="text-end"><strong>{{ lote.nutricional.alcohol }}</strong></td>
                                    <td class="text-end"><strong>% vol</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Nota:</strong> Los azúcares están incluidos dentro de los carbohidratos totales. 
                            Valores calculados según la receta estándar de CHOCOBREW.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Proceso de Elaboración -->
        <div class="row mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4">
                    <h4 class="fw-bold mb-4" style="color: #3E2723;">
                        <i class="fas fa-industry me-2" style="color: #8B4513;"></i>
                        Datos del Proceso
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><i class="fas fa-clock text-warning me-2"></i><strong>Fermentación:</strong> {{ lote.dias_fermentacion }} días</p>
                            <p><i class="fas fa-hourglass-half text-info me-2"></i><strong>Maduración:</strong> {{ lote.dias_maduracion }} días</p>
                        </div>
                        <div class="col-md-6">
                            <p><i class="fas fa-tint text-primary me-2"></i><strong>OG:</strong> {{ lote.og }}</p>
                            <p><i class="fas fa-flask text-secondary me-2"></i><strong>FG:</strong> {{ lote.fg }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones -->
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card-beer p-4 text-center">
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="{{ url_for('analisis') }}" class="btn btn-cacao">
                            <i class="fas fa-plus me-2"></i>Nuevo Lote
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="fas fa-print me-2"></i>Imprimir Todo
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>Inicio
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function descargarQR() {
        const qrImg = document.querySelector('.qr-container img');
        if (qrImg) {
            const link = document.createElement('a');
            link.href = qrImg.src;
            link.download = 'CHOCOBREW_{{ lote.codigo_lote }}_QR.png';
            link.click();
        }
    }
    
    function imprimirEtiqueta() {
        const contenido = document.querySelector('.qr-container').innerHTML;
        const ventana = window.open('', '_blank');
        ventana.document.write(`
            <html>
            <head>
                <title>Etiqueta {{ lote.codigo_lote }}</title>
                <style>
                    body { 
                        text-align: center; 
                        font-family: Arial, sans-serif;
                        padding: 20px;
                    }
                    h2 { color: #8B4513; }
                    .info { margin: 20px 0; }
                </style>
            </head>
            <body>
                <h2>CHOCOBREW</h2>
                <p><strong>Cerveza Artesanal de Cacao</strong></p>
                ${contenido}
                <div class="info">
                    <p>Lote: {{ lote.codigo_lote }}</p>
                    <p>Elaborado: {{ lote.fecha_elaboracion }}</p>
                    <p>Vence: {{ lote.fecha_vencimiento }}</p>
                    <p>ABV: {{ lote.abv }}% | Cacao: {{ lote.porcentaje_cacao }}%</p>
                </div>
            </body>
            </html>
        `);
        ventana.document.close();
        ventana.print();
    }
</script>
{% endblock %}